<app-header></app-header>
<div class="page">
  <div class="wrap-components">
    <div class="component search">
      <app-search isResult="true" searchTerm="{{ searchTerm$ | async }}"></app-search>
    </div>
    <div class="component">
      <app-stepper [data]="steps"></app-stepper>
    </div>
    <div class="component filters">
      <app-filter></app-filter>
    </div>
  </div>

  <app-error-card title="Não foi encontrado nenhum produto/medicamento." *ngIf="errors$ | async" description="Verifique se o campo da busca foi preeenchido
    corretamente. Caso contrário, solicite como
    falteiro ou fale com seu superior.">
  </app-error-card>

  <ng-template #loading>
    <mat-spinner color="primary" class="loader"></mat-spinner>
  </ng-template>

  <div *ngIf="selectedProducts$.length > 0">
    <span *ngFor="let product of selectedProducts$">
      {{ product.quantity }} - {{ product.shortName }}
    </span>
  </div>

  <ng-container *ngIf="dataSource.data?.length; else loading">
    <div class="product-grid-container">
      <table class="product-grid" mat-table [dataSource]="dataSource" *ngIf="dataSource.data.length > 0">
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null"
              [checked]="selection.isSelected(row)" color="primary">
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="type">
          <th class="text-center" mat-header-cell *matHeaderCellDef>Tipo</th>
          <td mat-cell *matCellDef="let product">
            <div class="product-type-icon">{{ product.typification }}</div>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nome</th>
          <td mat-cell *matCellDef="let product">{{ product.shortName }}</td>
        </ng-container>

        <ng-container matColumnDef="dosage">
          <th class="text-center" mat-header-cell *matHeaderCellDef>Dosagem</th>
          <td class="text-center" mat-cell *matCellDef="let product">{{ product.concentration }}</td>
        </ng-container>

        <ng-container matColumnDef="stock">
          <th class="text-center" mat-header-cell *matHeaderCellDef>Estoque</th>
          <td class="text-center" mat-cell *matCellDef="let product">{{ product.stock }}</td>
        </ng-container>

        <ng-container matColumnDef="basePrice">
          <th mat-header-cell *matHeaderCellDef>Preço Base</th>
          <td mat-cell *matCellDef="let product">
            <mat-radio-group name="{{selectedPrice + product.sku}}">
              <mat-radio-button value="{{product.basePrice}}" color="primary" class="product-grid-radio"
                (change)="updateValue(product.basePrice, product.sku, 'selectedPrice')">
                {{ product.basePrice | currency: 'BRL' || 'Não há' }}
              </mat-radio-button>
            </mat-radio-group>
          </td>
        </ng-container>

        <ng-container matColumnDef="vsPrice">
          <th class="text-center" mat-header-cell *matHeaderCellDef>Viva Saúde</th>
          <td class="text-center" mat-cell *matCellDef="let product">
            <div *ngIf="product.fidelizationPrice; else notApplicable">
              <mat-radio-group name="{{selectedPrice + product.sku}}">
                <mat-radio-button value="{{product.fidelizationPrice.value}}" color="primary" class="product-grid-radio"
                  (change)="updateValue(product.fidelizationPrice.value, product.sku, 'selectedPrice')">
                  {{ product.fidelizationPrice.value | currency: 'BRL' }}
                  <div class="text-left">
                    <small *ngIf="product.fidelizationPrice">(-{{ product.fidelizationPrice.percent }}%)</small>
                  </div>
                </mat-radio-button>
              </mat-radio-group>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="medicalAgreement">
          <th class="text-center" mat-header-cell *matHeaderCellDef>Convênio</th>
          <td class="text-center" mat-cell *matCellDef="let product">
            <div *ngIf="product.convenioPrice; else notApplicable">
              <div class="radio-group-option text-center">
                <div class="medical-agreement-select"><small><button>Sulamérica</button></small></div>
                <mat-radio-button color="primary" class="product-grid-radio">
                  {{ product.convenioPrice.value }}
                  <div class="text-left">
                    <small *ngIf="product.convenioPrice">(-{{ product.convenioPrice.percent }}%)</small>
                  </div>
                </mat-radio-button>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="pbm">
          <th class="text-center" mat-header-cell *matHeaderCellDef>PBM</th>
          <td class="text-center grouped-options" mat-cell *matCellDef="let product">
            <div *ngIf="product.pbmPrice; else notApplicable">
              <div class="radio-group-option text-center">
                <div class="medical-agreement-select"><small><button>Fidelize</button></small></div>
                <mat-radio-button color="primary" class="product-grid-radio">
                  {{ product.pbmPrice.value }}
                  <div>
                    <small *ngIf="product.pbmPrice">(-{{ product.pbmPrice.percent }}%)</small>
                  </div>
                </mat-radio-button>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="popFarm">
          <th class="text-center" mat-header-cell *matHeaderCellDef>Farm. Popular</th>
          <td class="text-center" mat-cell *matCellDef="let product">{{ product.popular ? 'Possui' : 'Não possui' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="progressiveDiscount">
          <th class="text-center" mat-header-cell *matHeaderCellDef>D.P</th>
          <td class="text-center" mat-cell *matCellDef="let product">
            <div *ngIf="product.pdPrice; else notApplicable"
              class="radio-group-option progressive-discount text-center">
              <mat-radio-button color="primary" class="product-grid-radio">
                <div class="price">
                  <div>{{ product.pdPrice.first }}</div>
                  <div>
                    <small>(0 unid)</small>
                  </div>
                </div>
                <div class="price">
                  <div>{{ product.pdPrice.last }}</div>
                  <div>
                    <small>(0 unid)</small>
                  </div>
                </div>
              </mat-radio-button>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="quantity">
          <th class="text-center" mat-header-cell *matHeaderCellDef> Quantidade </th>
          <td class="text-center" mat-cell *matCellDef="let product; let i = index">
            <div class="quantity-counter">
              <button (click)="incrementValue(pQuantity, product.sku, 'quantity')" class="increment"></button>
              <input #pQuantity value="{{ selectedProducts$[i]?.sku === product.sku ? '1' : '0' }}" matInput class="value" type="number" min="0" max="99" autocomplete="off"
                [textMask]="{mask: maskQuantity, guide: false}"
                (keyup)="updateValue($event.target.value, product.sku, 'quantity')">
              <button (click)="decrementValue(pQuantity, product.sku, 'quantity')" class="decrement"></button>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="prescription">
          <th class="text-center" mat-header-cell *matHeaderCellDef> Receita </th>
          <td class="text-center" mat-cell *matCellDef="let product">
            {{ product.prescription || 'Não há' }}
            <span *ngIf="product.prescription" class="prescription-color" [ngClass]="product.prescription"></span>
          </td>
        </ng-container>

        <tr class="product-grid-header" mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr class="product-grid-item" [ngClass]="{'highlighted': true}" mat-row
          *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </ng-container>

</div>

<!-- <ng-template #loading>
  Carregando...
</ng-template> -->

<ng-template #notApplicable>Não há</ng-template>
<!-- <ng-template #loading>
  <h1>Carregando</h1>
</ng-template> -->
